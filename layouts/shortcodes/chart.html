{{- $chartId := .Get "id" | default (.Get 0) -}}
{{- $chartData := "" -}}
{{- if site.Data.optimistic_charts -}}
  {{- $chartData = index site.Data.optimistic_charts $chartId -}}
{{- end -}}

{{- if $chartData -}}
<div class="chart-container" id="chart-{{ $chartId }}">
  
  {{- if $chartData.dataPoints -}}
  <div class="chart-visualization" id="chart-viz-{{ $chartId }}"></div>
  <script>
    (function() {
      const data = [
        {{- range $chartData.dataPoints -}}
        {year: {{ .year }}, value: {{ if eq $chartId "oil-spills" }}{{ div .value 1000 }}{{ else }}{{ .value }}{{ end }}},
        {{- end -}}
      ];
      
      const direction = "{{ $chartData.direction }}";
      
      // Find significant points based on direction
      let startPoint, currentPoint;
      if (direction === "down") {
        startPoint = data.reduce((max, p) => p.value > max.value ? p : max);
      } else {
        startPoint = data.reduce((min, p) => p.value < min.value ? p : min);
      }
      currentPoint = data[data.length - 1];
      
      const showArrow = Math.abs(startPoint.value - currentPoint.value) > 0.01 && 
                       startPoint.year !== currentPoint.year;
      
      // Chart dimensions
      const margin = {top: 20, right: 20, bottom: 40, left: 50};
      const width = 500 - margin.left - margin.right;
      const height = 120;
      const svgHeight = 250; // Fixed SVG height to match container
      
      // Create SVG
      const container = document.getElementById("chart-viz-{{ $chartId }}");
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", "100%");
      svg.setAttribute("height", svgHeight);
      svg.setAttribute("viewBox", `0 0 500 ${svgHeight}`);
      svg.style.fontFamily = "Helvetica, Arial, sans-serif";
      svg.style.fontSize = "10px";
      
      // Scales
      const xExtent = [Math.min(...data.map(d => d.year)), Math.max(...data.map(d => d.year))];
      const yExtent = [0, Math.max(...data.map(d => d.value))];
      
      const xScale = (year) => margin.left + ((year - xExtent[0]) / (xExtent[1] - xExtent[0])) * width;
      const yScale = (value) => margin.top + ((yExtent[1] - value) / (yExtent[1] - yExtent[0])) * height;
      
      // Create area path
      let areaPath = `M ${xScale(data[0].year)} ${yScale(0)}`;
      data.forEach(d => {
        areaPath += ` L ${xScale(d.year)} ${yScale(d.value)}`;
      });
      areaPath += ` L ${xScale(data[data.length - 1].year)} ${yScale(0)} Z`;
      
      // Add area fill
      const area = document.createElementNS("http://www.w3.org/2000/svg", "path");
      area.setAttribute("d", areaPath);
      area.setAttribute("fill", "#f5f5f5");
      area.setAttribute("fill-opacity", "0.6");
      svg.appendChild(area);
      
      // Create line path
      let linePath = `M ${xScale(data[0].year)} ${yScale(data[0].value)}`;
      data.slice(1).forEach(d => {
        linePath += ` L ${xScale(d.year)} ${yScale(d.value)}`;
      });
      
      // Add main line
      const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
      line.setAttribute("d", linePath);
      line.setAttribute("stroke", "#000000");
      line.setAttribute("stroke-width", "1.5");
      line.setAttribute("fill", "none");
      svg.appendChild(line);
      
      // Add x-axis at y=0 position
      const xAxisY = yScale(0);
      
      // Create x-axis ticks - show start, middle, and end years
      const xTicks = [
        xExtent[0], 
        Math.round((xExtent[0] + xExtent[1]) / 2), 
        xExtent[1]
      ];
      
      xTicks.forEach(year => {
        const x = xScale(year);
        
        // Add tick mark
        const tick = document.createElementNS("http://www.w3.org/2000/svg", "line");
        tick.setAttribute("x1", x);
        tick.setAttribute("y1", xAxisY);
        tick.setAttribute("x2", x);
        tick.setAttribute("y2", xAxisY + 3);
        tick.setAttribute("stroke", "#666666");
        tick.setAttribute("stroke-width", "1");
        svg.appendChild(tick);
        
        // Add year label
        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", x);
        label.setAttribute("y", xAxisY + 15);
        label.setAttribute("text-anchor", "middle");
        label.setAttribute("font-size", "10");
        label.setAttribute("font-family", "Helvetica, Arial, sans-serif");
        label.setAttribute("fill", "#666666");
        label.textContent = year;
        svg.appendChild(label);
      });
      
      // Add x-axis line
      const xAxisLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
      xAxisLine.setAttribute("x1", margin.left);
      xAxisLine.setAttribute("y1", xAxisY);
      xAxisLine.setAttribute("x2", margin.left + width);
      xAxisLine.setAttribute("y2", xAxisY);
      xAxisLine.setAttribute("stroke", "#666666");
      xAxisLine.setAttribute("stroke-width", "1");
      svg.appendChild(xAxisLine);

      // Add data points
      data.forEach(d => {
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", xScale(d.year));
        circle.setAttribute("cy", yScale(d.value));
        circle.setAttribute("r", "2");
        circle.setAttribute("fill", "#000000");
        
        // Add tooltip
        const title = document.createElementNS("http://www.w3.org/2000/svg", "title");
        title.textContent = `${d.value.toFixed(1)} (${d.year})`;
        circle.appendChild(title);
        
        svg.appendChild(circle);
      });
      
      // Add arrow line if showing progress
      if (showArrow) {
        const progressData = data.filter(d => d.year >= startPoint.year && d.year <= currentPoint.year);
        let progressPath = `M ${xScale(progressData[0].year)} ${yScale(progressData[0].value)}`;
        progressData.slice(1).forEach(d => {
          progressPath += ` L ${xScale(d.year)} ${yScale(d.value)}`;
        });
        
        const progressLine = document.createElementNS("http://www.w3.org/2000/svg", "path");
        progressLine.setAttribute("d", progressPath);
        progressLine.setAttribute("stroke", "#000000");
        progressLine.setAttribute("stroke-width", "4");
        progressLine.setAttribute("stroke-opacity", "0.6");
        progressLine.setAttribute("fill", "none");
        progressLine.setAttribute("marker-end", "url(#arrow)");
        svg.appendChild(progressLine);
        
        // Add arrow marker definition
        const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
        const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
        marker.setAttribute("id", "arrow");
        marker.setAttribute("viewBox", "0 0 10 6");
        marker.setAttribute("refX", "0");
        marker.setAttribute("refY", "3");
        marker.setAttribute("markerWidth", "6");
        marker.setAttribute("markerHeight", "5");
        marker.setAttribute("orient", "auto");
        marker.setAttribute("markerUnits", "strokeWidth");
        
        const arrowPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        arrowPath.setAttribute("d", "M0,0 L0,6 L10,3 z");
        arrowPath.setAttribute("fill", "#000000");
        arrowPath.setAttribute("fill-opacity", "0.8");
        marker.appendChild(arrowPath);
        defs.appendChild(marker);
        svg.insertBefore(defs, svg.firstChild);
        
        // Data labels: default positions only, based on direction
        const config = (direction === "down")
          ? { start: "below", end: "above" }
          : { start: "above", end: "below" };

        // Use asymmetric spacing so "above" labels sit a bit farther
        const distanceAbove = 22; // px
        const distanceBelow = 12; // px
        const startDistance = config.start === "above" ? distanceAbove : distanceBelow;
        const endDistance = config.end === "above" ? distanceAbove : distanceBelow;

        // Screen-space points for interpolation and label-to-line clearance clamp
        const pts = data.map(d => ({ x: xScale(d.year), y: yScale(d.value) }));
        const yOnLine = (x) => {
          let best = pts[0];
          for (let i = 0; i < pts.length - 1; i++) {
            const p0 = pts[i], p1 = pts[i + 1];
            const minX = Math.min(p0.x, p1.x), maxX = Math.max(p0.x, p1.x);
            if (x >= minX && x <= maxX && maxX !== minX) {
              const t = (x - p0.x) / (p1.x - p0.x);
              return p0.y + t * (p1.y - p0.y);
            }
            // Track nearest endpoint if outside segment ranges
            if (Math.abs(x - p0.x) < Math.abs(x - best.x)) best = p0;
            if (Math.abs(x - p1.x) < Math.abs(x - best.x)) best = p1;
          }
          return best.y;
        };

        const clearanceAbove = 18; // ensure at least this many px above the line
        const clearanceBelow = 10; // ensure at least this many px below the line

        const adjustLabelPair = (valueEl, yearEl, x, side) => {
          // Measure current sizes
          const vb = valueEl.getBBox();
          const yb = yearEl.getBBox();
          const gap = 12;
          const blockH = vb.height + gap + yb.height;
          const yLine = yOnLine(x);

          if (side === 'above') {
            const bottom = yLine - clearanceAbove;
            const valueBaseline = bottom - yb.height - gap + (vb.height * 0.8);
            const yearBaseline = bottom - (yb.height * 0.2);
            valueEl.setAttribute('y', Math.max(margin.top + 15, valueBaseline));
            yearEl.setAttribute('y', Math.max(margin.top + 27, yearBaseline));
          } else { // below
            const top = yLine + clearanceBelow;
            const valueBaseline = top + (vb.height * 0.8);
            const yearBaseline = valueBaseline + gap + (yb.height * 0.8);
            valueEl.setAttribute('y', Math.min(margin.top + height - 15, valueBaseline));
            yearEl.setAttribute('y', Math.min(margin.top + height - 3, yearBaseline));
          }
        };

        // Helper function to get label position based on config
        const getLabelPosition = (point, position, distance) => {
          const pointY = Math.max(margin.top + 10, Math.min(yScale(point.value), margin.top + height - 25));
          const pointX = xScale(point.year);
          
          if (position === "above") {
            return {
              valueY: Math.max(margin.top + 15, pointY - distance),
              yearY: Math.max(margin.top + 27, pointY - (distance - 12)),
              x: pointX
            };
          } else if (position === "below") {
            return {
              valueY: Math.min(margin.top + height - 15, pointY + distance),
              yearY: Math.min(margin.top + height - 3, pointY + distance + 12),
              x: pointX
            };
          } else if (position === "left") {
            return {
              valueY: pointY - 6,
              yearY: pointY + 6,
              x: Math.max(margin.left + 25, pointX - 25)
            };
          } else if (position === "right") {
            return {
              valueY: pointY - 6,
              yearY: pointY + 6,
              x: Math.min(margin.left + width - 25, pointX + 25)
            };
          }
        };
        
        // Start point labels
        const startPos = getLabelPosition(startPoint, config.start, startDistance);
        const startValueLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        startValueLabel.setAttribute("x", startPos.x);
        startValueLabel.setAttribute("y", startPos.valueY);
        startValueLabel.setAttribute("text-anchor", config.start === "left" ? "end" : config.start === "right" ? "start" : "middle");
        startValueLabel.setAttribute("font-size", "18");
        startValueLabel.setAttribute("font-weight", "bold");
        startValueLabel.setAttribute("font-family", "Helvetica, Arial, sans-serif");
        startValueLabel.setAttribute("fill", "#000000");
        startValueLabel.textContent = startPoint.value.toFixed(1);
        svg.appendChild(startValueLabel);
        
        const startYearLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        startYearLabel.setAttribute("x", startPos.x);
        startYearLabel.setAttribute("y", startPos.yearY);
        startYearLabel.setAttribute("text-anchor", config.start === "left" ? "end" : config.start === "right" ? "start" : "middle");
        startYearLabel.setAttribute("font-size", "14");
        startYearLabel.setAttribute("font-family", "Helvetica, Arial, sans-serif");
        startYearLabel.setAttribute("fill", "#666666");
        startYearLabel.textContent = startPoint.year;
        svg.appendChild(startYearLabel);

        // End point labels
        const endPos = getLabelPosition(currentPoint, config.end, endDistance);
        const endValueLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        endValueLabel.setAttribute("x", endPos.x);
        endValueLabel.setAttribute("y", endPos.valueY);
        endValueLabel.setAttribute("text-anchor", config.end === "left" ? "end" : config.end === "right" ? "start" : "middle");
        endValueLabel.setAttribute("font-size", "18");
        endValueLabel.setAttribute("font-weight", "bold");
        endValueLabel.setAttribute("font-family", "Helvetica, Arial, sans-serif");
        endValueLabel.setAttribute("fill", "#000000");
        endValueLabel.textContent = currentPoint.value.toFixed(1);
        svg.appendChild(endValueLabel);
        
        const endYearLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        endYearLabel.setAttribute("x", endPos.x);
        endYearLabel.setAttribute("y", endPos.yearY);
        endYearLabel.setAttribute("text-anchor", config.end === "left" ? "end" : config.end === "right" ? "start" : "middle");
        endYearLabel.setAttribute("font-size", "14");
        endYearLabel.setAttribute("font-family", "Helvetica, Arial, sans-serif");
        endYearLabel.setAttribute("fill", "#666666");
        endYearLabel.textContent = currentPoint.year;
        svg.appendChild(endYearLabel);

        // Ensure a minimum clearance from the line so labels don't get too close when clamped to the top
        adjustLabelPair(startValueLabel, startYearLabel, xScale(startPoint.year), config.start);
        adjustLabelPair(endValueLabel, endYearLabel, xScale(currentPoint.year), config.end);

      }
      
      container.appendChild(svg);
    })();
  </script>
  {{- end -}}
  
</div>
{{- else -}}
<div class="chart-error">
  <p>Chart data not available for: {{ $chartId }}</p>
</div>
{{- end -}}
