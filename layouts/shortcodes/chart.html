{{- $chartId := .Get "id" | default (.Get 0) -}}
{{- $chartData := "" -}}
{{- if site.Data.optimistic_charts -}}
  {{- $chartData = index site.Data.optimistic_charts $chartId -}}
{{- end -}}

{{- if $chartData -}}
<div class="chart-container" id="chart-{{ $chartId }}">
  <div class="chart-header">
    <h4>{{ $chartData.title }}</h4>
  </div>
  
  {{- if $chartData.dataPoints -}}
  <div class="chart-visualization" id="chart-viz-{{ $chartId }}"></div>
  <script>
    (function() {
      const data = [
        {{- range $chartData.dataPoints -}}
        {year: {{ .year }}, value: {{ .value }}},
        {{- end -}}
      ];
      
      const direction = "{{ $chartData.direction }}";
      
      // Find significant points based on direction
      let startPoint, currentPoint;
      if (direction === "down") {
        startPoint = data.reduce((max, p) => p.value > max.value ? p : max);
      } else {
        startPoint = data.reduce((min, p) => p.value < min.value ? p : min);
      }
      currentPoint = data[data.length - 1];
      
      const showArrow = Math.abs(startPoint.value - currentPoint.value) > 0.01 && 
                       startPoint.year !== currentPoint.year;
      
      // Chart dimensions
      const margin = {top: 20, right: 20, bottom: 30, left: 50};
      const width = 500 - margin.left - margin.right;
      const height = 150 - margin.top - margin.bottom;
      
      // Create SVG
      const container = document.getElementById("chart-viz-{{ $chartId }}");
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", "100%");
      svg.setAttribute("height", "150");
      svg.setAttribute("viewBox", `0 0 500 150`);
      svg.style.fontFamily = "Helvetica, Arial, sans-serif";
      svg.style.fontSize = "10px";
      
      // Scales
      const xExtent = [Math.min(...data.map(d => d.year)), Math.max(...data.map(d => d.year))];
      const yExtent = [0, Math.max(...data.map(d => d.value))];
      
      const xScale = (year) => margin.left + ((year - xExtent[0]) / (xExtent[1] - xExtent[0])) * width;
      const yScale = (value) => margin.top + ((yExtent[1] - value) / (yExtent[1] - yExtent[0])) * height;
      
      // Create area path
      let areaPath = `M ${xScale(data[0].year)} ${yScale(0)}`;
      data.forEach(d => {
        areaPath += ` L ${xScale(d.year)} ${yScale(d.value)}`;
      });
      areaPath += ` L ${xScale(data[data.length - 1].year)} ${yScale(0)} Z`;
      
      // Add area fill
      const area = document.createElementNS("http://www.w3.org/2000/svg", "path");
      area.setAttribute("d", areaPath);
      area.setAttribute("fill", "#f5f5f5");
      area.setAttribute("fill-opacity", "0.6");
      svg.appendChild(area);
      
      // Create line path
      let linePath = `M ${xScale(data[0].year)} ${yScale(data[0].value)}`;
      data.slice(1).forEach(d => {
        linePath += ` L ${xScale(d.year)} ${yScale(d.value)}`;
      });
      
      // Add main line
      const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
      line.setAttribute("d", linePath);
      line.setAttribute("stroke", "#000000");
      line.setAttribute("stroke-width", "1.5");
      line.setAttribute("fill", "none");
      svg.appendChild(line);
      
      // Add data points
      data.forEach(d => {
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", xScale(d.year));
        circle.setAttribute("cy", yScale(d.value));
        circle.setAttribute("r", "2");
        circle.setAttribute("fill", "#000000");
        
        // Add tooltip
        const title = document.createElementNS("http://www.w3.org/2000/svg", "title");
        title.textContent = `${d.value.toFixed(1)} (${d.year})`;
        circle.appendChild(title);
        
        svg.appendChild(circle);
      });
      
      // Add arrow line if showing progress
      if (showArrow) {
        const progressData = data.filter(d => d.year >= startPoint.year && d.year <= currentPoint.year);
        let progressPath = `M ${xScale(progressData[0].year)} ${yScale(progressData[0].value)}`;
        progressData.slice(1).forEach(d => {
          progressPath += ` L ${xScale(d.year)} ${yScale(d.value)}`;
        });
        
        const progressLine = document.createElementNS("http://www.w3.org/2000/svg", "path");
        progressLine.setAttribute("d", progressPath);
        progressLine.setAttribute("stroke", "#000000");
        progressLine.setAttribute("stroke-width", "4");
        progressLine.setAttribute("stroke-opacity", "0.6");
        progressLine.setAttribute("fill", "none");
        progressLine.setAttribute("marker-end", "url(#arrow)");
        svg.appendChild(progressLine);
        
        // Add arrow marker definition
        const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
        const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
        marker.setAttribute("id", "arrow");
        marker.setAttribute("viewBox", "0 0 10 6");
        marker.setAttribute("refX", "0");
        marker.setAttribute("refY", "3");
        marker.setAttribute("markerWidth", "6");
        marker.setAttribute("markerHeight", "5");
        marker.setAttribute("orient", "auto");
        marker.setAttribute("markerUnits", "strokeWidth");
        
        const arrowPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        arrowPath.setAttribute("d", "M0,0 L0,6 L10,3 z");
        arrowPath.setAttribute("fill", "#000000");
        arrowPath.setAttribute("fill-opacity", "0.8");
        marker.appendChild(arrowPath);
        defs.appendChild(marker);
        svg.insertBefore(defs, svg.firstChild);
        
        // Add data labels for start and end points with manual positioning
        const chartId = "{{ $chartId }}";
        
        // Manual positioning configurations based on extracted data
        const labelConfigs = {
          "legal-slavery": { start: "above", end: "right", distance: 20, unit: "countries" },
          "oil-spills": { start: "above", end: "right", distance: 20, unit: "k tons/year" },
          "solar-price": { start: "above", end: "right", distance: 20, unit: "$/W" },
          "battle-deaths": { start: "above", end: "right", distance: 22, unit: "per 100k" },
          "child-mortality": { start: "above", end: "right", distance: 20, unit: "%" },
          "death-penalty": { start: "above", end: "right", distance: 25, unit: "countries" },
          "leaded-gasoline": { start: "above", end: "right", distance: 22, unit: "countries" },
          "plane-deaths": { start: "above", end: "right", distance: 22, unit: "per 10bn miles" },
          "disaster-deaths": { start: "above", end: "right", distance: 20, unit: "k deaths/year" },
          "nuclear-warheads": { start: "above", end: "right", distance: 25, unit: "thousands" },
          "smallpox": { start: "above", end: "right", distance: 25, unit: "countries" },
          "so2-emissions": { start: "above", end: "right", distance: 18, unit: "kg per person" },
          "ozone-depletion": { start: "above", end: "right", distance: 18, unit: "k tons ODS" },
          "hunger": { start: "above", end: "right", distance: 20, unit: "%" },
          "protected-areas": { start: "above", end: "right", distance: 15, unit: "%" },
          "scientific-papers": { start: "above", end: "right", distance: 12, unit: "per year" },
          "cereal-yield": { start: "above", end: "right", distance: 18, unit: "t/ha" },
          "literacy": { start: "above", end: "right", distance: 15, unit: "%" },
          "democracy": { start: "above", end: "right", distance: 15, unit: "%" },
          "girls-school": { start: "above", end: "right", distance: 15, unit: "%" },
          "electricity": { start: "above", end: "right", distance: 12, unit: "%" },
          "mobile-phones": { start: "above", end: "right", distance: 12, unit: "%" },
          "water-access": { start: "above", end: "right", distance: 12, unit: "%" },
          "internet": { start: "above", end: "right", distance: 12, unit: "%" },
          // Keep existing configs for charts not in the extracted data
          "co2-intensity": { start: "above", end: "below", distance: 18 },
          "extreme-poverty": { start: "above", end: "below", distance: 25 },
          "life-expectancy": { start: "below", end: "above", distance: 18 },
          "maternal-mortality": { start: "above", end: "below", distance: 20 },
          "renewable-energy": { start: "below", end: "above", distance: 12 }
        };
        
        const config = labelConfigs[chartId] || { start: "above", end: "above", distance: 15 };
        
        // Helper function to get label position based on config
        const getLabelPosition = (point, position, distance) => {
          const pointY = yScale(point.value);
          const pointX = xScale(point.year);
          
          if (position === "above") {
            return {
              valueY: pointY - distance,
              yearY: pointY - (distance - 12),
              x: pointX
            };
          } else if (position === "below") {
            return {
              valueY: pointY + 12,
              yearY: pointY + 24,
              x: pointX
            };
          } else if (position === "left") {
            return {
              valueY: pointY - 6,
              yearY: pointY + 6,
              x: pointX - 25
            };
          } else if (position === "right") {
            return {
              valueY: pointY - 6,
              yearY: pointY + 6,
              x: pointX + 25
            };
          }
        };
        
        // Start point labels
        const startPos = getLabelPosition(startPoint, config.start, config.distance);
        const startValueLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        startValueLabel.setAttribute("x", startPos.x);
        startValueLabel.setAttribute("y", startPos.valueY);
        startValueLabel.setAttribute("text-anchor", config.start === "left" ? "end" : config.start === "right" ? "start" : "middle");
        startValueLabel.setAttribute("font-size", "18");
        startValueLabel.setAttribute("font-weight", "bold");
        startValueLabel.setAttribute("font-family", "Helvetica, Arial, sans-serif");
        startValueLabel.setAttribute("fill", "#000000");
        startValueLabel.textContent = startPoint.value.toFixed(1);
        svg.appendChild(startValueLabel);
        
        const startYearLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        startYearLabel.setAttribute("x", startPos.x);
        startYearLabel.setAttribute("y", startPos.yearY);
        startYearLabel.setAttribute("text-anchor", config.start === "left" ? "end" : config.start === "right" ? "start" : "middle");
        startYearLabel.setAttribute("font-size", "14");
        startYearLabel.setAttribute("font-family", "Helvetica, Arial, sans-serif");
        startYearLabel.setAttribute("fill", "#666666");
        startYearLabel.textContent = startPoint.year;
        svg.appendChild(startYearLabel);
        
        // End point labels
        const endPos = getLabelPosition(currentPoint, config.end, config.distance);
        const endValueLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        endValueLabel.setAttribute("x", endPos.x);
        endValueLabel.setAttribute("y", endPos.valueY);
        endValueLabel.setAttribute("text-anchor", config.end === "left" ? "end" : config.end === "right" ? "start" : "middle");
        endValueLabel.setAttribute("font-size", "18");
        endValueLabel.setAttribute("font-weight", "bold");
        endValueLabel.setAttribute("font-family", "Helvetica, Arial, sans-serif");
        endValueLabel.setAttribute("fill", "#000000");
        endValueLabel.textContent = currentPoint.value.toFixed(1);
        svg.appendChild(endValueLabel);
        
        const endYearLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        endYearLabel.setAttribute("x", endPos.x);
        endYearLabel.setAttribute("y", endPos.yearY);
        endYearLabel.setAttribute("text-anchor", config.end === "left" ? "end" : config.end === "right" ? "start" : "middle");
        endYearLabel.setAttribute("font-size", "14");
        endYearLabel.setAttribute("font-family", "Helvetica, Arial, sans-serif");
        endYearLabel.setAttribute("fill", "#666666");
        endYearLabel.textContent = currentPoint.year;
        svg.appendChild(endYearLabel);
        
      }
      
      container.appendChild(svg);
    })();
  </script>
  {{- end -}}
  
  <div class="chart-footer">
    <small>
      Source: 
      {{- if eq $chartData.source "owid" -}}
        <a href="https://ourworldindata.org/grapher/{{ $chartData.slug }}" target="_blank">Our World in Data</a>
      {{- else -}}
        {{ $chartData.source }}
      {{- end -}}
      {{- if $chartData.lastUpdated -}}
        â€¢ Updated: {{ dateFormat "Jan 2, 2006" $chartData.lastUpdated }}
      {{- end -}}
    </small>
  </div>
</div>
{{- else -}}
<div class="chart-error">
  <p>Chart data not available for: {{ $chartId }}</p>
</div>
{{- end -}}